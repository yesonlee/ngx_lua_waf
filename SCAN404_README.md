# 404扫描检测功能使用说明

## 功能概述

本功能用于检测和限制恶意404扫描行为，通过统计IP地址在特定时间窗口内的404请求次数，自动封禁超过阈值的恶意IP。

## 配置参数

在 `config.lua` 文件中添加以下配置：

```lua
-- 检测并限制恶意404扫描行为
Scan404="on"                    -- 是否启用404扫描检测
Scan404Window=180              -- 统计窗口大小（秒）
Scan404MaxCount=6              -- 窗口内404请求次数阈值
Scan404BlockDuration=3600      -- 触发阈值后封禁时长（秒）
```

## Nginx配置要求

在 `nginx.conf.waf.conf` 中添加共享字典配置：

```nginx
lua_shared_dict scan404 5m;    -- 404扫描统计字典
lua_shared_dict blockip 5m;    -- IP封禁字典
```

## 功能特性

1. **智能统计**: 在180秒时间窗口内统计404请求次数
2. **自动封禁**: 超过6次404请求自动封禁IP 3600秒
3. **独立计数**: 每个IP地址独立计数，互不影响
4. **时间窗口重置**: 超过时间窗口自动重置计数器
5. **日志记录**: 检测到恶意扫描时会记录详细日志

## 检测逻辑

1. 只处理HTTP状态码为404的请求
2. 对每个客户端IP进行独立计数
3. 在180秒时间窗口内统计请求次数
4. 如果请求次数达到6次，立即封禁该IP
5. 封禁时长为3600秒（1小时）
6. 封禁后重置该IP的计数器

## 测试方法

### Python测试脚本
```bash
python3 test_scan404.py
```

### Lua测试脚本
```bash
lua test_scan404.lua
```

## 集成到WAF

404扫描检测功能已经集成到WAF的主流程中，在 `waf.lua` 文件中添加了检测调用：

```lua
if whiteip() then
elseif blockip() then
elseif denycc() then
elseif scan_404() then    -- 新增的404扫描检测
elseif ngx.var.http_Acunetix_Aspect then
```

## 日志输出

当检测到恶意404扫描时，会在安全日志中记录如下信息：

```
SCAN404 /nonexistent/path - 恶意404扫描检测，IP: 10.0.0.1 请求次数: 6
```

## 性能考虑

- 使用Nginx共享字典，内存操作，性能高效
- 每个IP的扫描信息使用base64编码存储
- 设置合理的过期时间，避免内存泄漏
- 统计窗口和阈值可配置，适应不同场景

## 注意事项

1. 确保Nginx配置中正确设置了共享字典大小
2. 根据实际业务调整阈值参数，避免误判
3. 生产环境建议先观察日志，再调整阈值
4. 封禁功能依赖于WAF的blockip机制

## 版本要求

- OpenResty 1.15.8+ 或 Nginx with Lua模块
- LuaJIT 2.1+ 推荐

## 故障排除

如果功能不生效，请检查：

1. Nginx错误日志中是否有Lua语法错误
2. 共享字典是否正确配置
3. 404状态码是否正确传递到Lua模块
4. 配置参数是否正确加载

## 自定义扩展

可以根据需要修改 `init.lua` 中的 `scan_404()` 函数：

- 调整检测算法
- 添加白名单机制
- 修改封禁策略
- 增加更复杂的攻击模式识别